<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Questionnaire de pré-diagnostic — CLN</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="navbar">
        <a class="brand" href="index.html">
          <img src="LOGO_CLN.png" alt="Logo CLN" />
          <span>CLN · Solutions intelligentes</span>
        </a>
        <nav class="nav-links">
          <a href="index.html">Accueil</a>
          <a href="solutions.html">Solutions</a>
          <a href="approche.html">Notre approche</a>
          <a href="realisations.html">Réalisations</a>
          <a class="active" href="diagnostic.html">Diagnostic</a>
          <a href="contact.html">Contact</a>
        </nav>
        <a class="cta-button" href="contact.html">Être recontacté</a>
      </div>
    </header>
    <main>
      <section>
        <h1 class="section-title">Questionnaire de pré-diagnostic</h1>
        <p class="section-lead">
          En moins de deux minutes, précisez votre contexte et recevez une proposition d'accompagnement CLN adaptée. Nous vous suggérerons ensuite de planifier un rendez-vous pour aller plus loin.
        </p>
      </section>

      <section class="questionnaire">
        <form id="diagnostic-form">
          <fieldset>
            <legend>Quels sont vos enjeux principaux ?</legend>
            <p class="helper-text">
              Cochez toutes les thématiques les plus pertinentes pour vous
              <span id="modules-count" class="selection-count">(0 sélectionnée)</span>
            </p>
            <div class="pill-group">
              <label class="pill">
                <input type="checkbox" name="modules" value="connecter" />
                Connecter · Interopérabilité
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="liberer" />
                Libérer · Automatisation
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="normaliser" />
                Normaliser · Gouvernance des données
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="securiser" />
                Sécuriser · Conformité
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="valoriser" />
                Valoriser · Analytics
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="collaborer" />
                Collaborer · Partage
              </label>
              <label class="pill">
                <input type="checkbox" name="modules" value="anticiper" />
                Anticiper · Innovation
              </label>
              <label class="pill pill--custom">
                <input type="checkbox" name="modules" value="autre" />
                <span>Autre enjeu</span>
                <input
                  type="text"
                  id="autre-enjeu"
                  name="autreEnjeu"
                  class="pill-text-input"
                  placeholder="Décrivez votre enjeu"
                  autocomplete="off"
                />
              </label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Taille de votre organisation</legend>
            <div class="radio-list">
              <label><input type="radio" name="taille" value="petite" required /> Moins de 50 collaborateurs</label>
              <label><input type="radio" name="taille" value="moyenne" /> 50 à 250 collaborateurs</label>
              <label><input type="radio" name="taille" value="grande" /> Plus de 250 collaborateurs</label>
              <label><input type="radio" name="taille" value="tresgrande" /> Plus de 2&nbsp;500 collaborateurs</label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Priorité des 6 prochains mois</legend>
            <p class="helper-text">
              Vous pouvez classer les axes ci-dessous par ordre d'importance (1 = priorité la plus forte).
              Activez l'option si vous souhaitez préciser vos priorités.
            </p>
            <label class="priority-toggle">
              <input type="checkbox" id="priorite-toggle" />
              <span>Je souhaite indiquer l'ordre de priorité</span>
            </label>
            <div class="priority-list is-disabled" role="list" hidden></div>
            <input type="hidden" name="priorite" id="priorite-input" />
          </fieldset>

          <fieldset>
            <legend>Horizon de mise en œuvre souhaité</legend>
            <div class="radio-list">
              <label><input type="radio" name="delai" value="court" required /> Moins de 3 mois</label>
              <label><input type="radio" name="delai" value="moyen" /> 3 à 6 mois</label>
              <label><input type="radio" name="delai" value="long" /> Plus de 6 mois</label>
              <label><input type="radio" name="delai" value="incertain" /> Je ne sais pas encore</label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Quel mode d'accompagnement imaginez-vous ?</legend>
            <div class="radio-list">
              <label><input type="radio" name="mode" value="flash" required /> Diagnostic flash pour prioriser</label>
              <label><input type="radio" name="mode" value="projet" /> Pilotage complet du projet</label>
              <label><input type="radio" name="mode" value="hybride" /> Coaching interne + expertise ciblée</label>
            </div>
          </fieldset>

          <button class="cta-button" type="submit">Obtenir ma recommandation</button>
        </form>

        <div id="diagnostic-resultat" class="result-card" hidden>
          <h2>Votre synthèse personnalisée</h2>
          <div id="resultat-insights"></div>
          <a class="cta-button" href="contact.html">Planifier un rendez-vous</a>
        </div>
      </section>
    </main>
    <footer>
      <div class="footer-inner">
        <span>© CLN — Solutions intelligentes pour vos SI.</span>
        <div class="footer-links">
          <a href="mailto:contact@cln-solutions.fr">contact@cln-solutions.fr</a>
          <a href="contact.html">Prendre rendez-vous</a>
          <a href="#">Mentions légales</a>
        </div>
      </div>
    </footer>

    <script>
      const form = document.getElementById('diagnostic-form');
      const card = document.getElementById('diagnostic-resultat');
      const insightsContainer = document.getElementById('resultat-insights');
      const moduleInputs = form.querySelectorAll('input[name="modules"]');
      const moduleCount = document.getElementById('modules-count');
      const customCheckbox = form.querySelector('input[name="modules"][value="autre"]');
      const customInput = document.getElementById('autre-enjeu');
      const customPill = customInput ? customInput.closest('.pill--custom') : null;
      const priorityList = document.querySelector('.priority-list');
      const priorityInput = document.getElementById('priorite-input');
      const priorityToggle = document.getElementById('priorite-toggle');
      const PRIORITY_LABELS = {
        connecter: 'Connecter · Interopérabilité',
        liberer: 'Libérer · Automatisation',
        normaliser: 'Normaliser · Gouvernance des données',
        securiser: 'Sécuriser · Conformité',
        valoriser: 'Valoriser · Analytics',
        collaborer: 'Collaborer · Partage',
        anticiper: 'Anticiper · Innovation'
      };

      function escapeHtml(text) {
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function ensureTrailingPunctuation(text) {
        return /[.!?]$/.test(text.trim()) ? '' : '.';
      }

      function moduleDisplayLabel(value) {
        if (PRIORITY_LABELS[value]) {
          return PRIORITY_LABELS[value];
        }
        const input = Array.from(moduleInputs).find((element) => element.value === value);
        if (input && input.closest('label')) {
          return input.closest('label').textContent.trim();
        }
        return value;
      }

      function buildEntry(value, label) {
        return {
          value,
          label,
          key: value === 'autre' ? `autre:${label}` : value
        };
      }

      function getSelectedModuleEntries() {
        const entries = [];
        moduleInputs.forEach((input) => {
          if (!input.checked) {
            return;
          }
          if (input.value === 'autre') {
            const text = customInput.value.trim();
            if (text) {
              entries.push(buildEntry('autre', text));
            }
            return;
          }
          const label = moduleDisplayLabel(input.value);
          entries.push(buildEntry(input.value, label));
        });
        return entries;
      }

      function getPriorityItems() {
        if (!priorityList) {
          return [];
        }
        return Array.from(priorityList.querySelectorAll('.priority-item'));
      }

      function createPriorityItem(entry) {
        const item = document.createElement('div');
        item.className = 'priority-item';
        item.dataset.value = entry.value;
        item.dataset.label = entry.label;
        item.dataset.key = entry.key;
        item.setAttribute('role', 'listitem');

        const rank = document.createElement('span');
        rank.className = 'priority-rank';
        rank.textContent = '0';
        item.appendChild(rank);

        const labelSpan = document.createElement('span');
        labelSpan.className = 'priority-label';
        labelSpan.textContent = entry.label;
        item.appendChild(labelSpan);

        const actions = document.createElement('div');
        actions.className = 'priority-actions';

        const upButton = document.createElement('button');
        upButton.type = 'button';
        upButton.className = 'priority-move priority-up';
        upButton.setAttribute('aria-label', 'Monter');
        upButton.textContent = '\u25B2';
        actions.appendChild(upButton);

        const downButton = document.createElement('button');
        downButton.type = 'button';
        downButton.className = 'priority-move priority-down';
        downButton.setAttribute('aria-label', 'Descendre');
        downButton.textContent = '\u25BC';
        actions.appendChild(downButton);

        item.appendChild(actions);
        return item;
      }

      function buildPriorityList(entries) {
        if (!priorityList) {
          return;
        }
        const previousOrder = getPriorityOrder();
        const orderMap = new Map(previousOrder.map((entry, index) => [entry.key, index]));
        const sortedEntries = [...entries].sort((a, b) => {
          const aIndex = orderMap.has(a.key) ? orderMap.get(a.key) : Number.MAX_SAFE_INTEGER;
          const bIndex = orderMap.has(b.key) ? orderMap.get(b.key) : Number.MAX_SAFE_INTEGER;
          if (aIndex !== bIndex) {
            return aIndex - bIndex;
          }
          return entries.indexOf(a) - entries.indexOf(b);
        });

        priorityList.innerHTML = '';
        sortedEntries.forEach((entry) => {
          priorityList.appendChild(createPriorityItem(entry));
        });

        refreshPriorityUI();
      }

      function isPriorityEnabled() {
        return priorityToggle ? priorityToggle.checked : true;
      }

      function refreshPriorityUI() {
        if (!priorityList) {
          return;
        }
        const items = getPriorityItems();
        const hasItems = items.length > 0;

        if (priorityToggle) {
          if (!hasItems) {
            priorityToggle.checked = false;
          }
          priorityToggle.disabled = !hasItems;
        }

        const enabled = hasItems && isPriorityEnabled();
        priorityList.classList.toggle('is-disabled', !enabled);
        priorityList.hidden = !enabled;
        priorityList.style.display = enabled ? 'grid' : 'none';
        priorityList.setAttribute('aria-disabled', enabled ? 'false' : 'true');

        items.forEach((item, index) => {
          const rank = item.querySelector('.priority-rank');
          const upButton = item.querySelector('.priority-up');
          const downButton = item.querySelector('.priority-down');
          if (rank) {
            rank.textContent = index + 1;
          }
          if (upButton) {
            upButton.disabled = index === 0 || !enabled;
          }
          if (downButton) {
            downButton.disabled = index === items.length - 1 || !enabled;
          }
        });
        if (priorityInput) {
          const firstItem = items[0];
          priorityInput.value = enabled && firstItem ? firstItem.dataset.key : '';
        }
      }

      function getPriorityOrder() {
        return getPriorityItems().map((item) => ({
          value: item.dataset.value,
          label: item.dataset.label,
          key: item.dataset.key
        }));
      }

      function buildPriorityOrderSummary(order, enabled) {
        if (!enabled) {
          return "Vous n'avez pas activé le classement des priorités pour le moment. Activez l'option ci-dessus pour définir un ordre.";
        }
        if (!order.length) {
          return "Vous n'avez pas encore classé vos priorités.";
        }
        const readable = order
          .map((entry, index) => `${index + 1}. ${escapeHtml(entry.label)}`)
          .join(' | ');
        return `Priorités classées : ${readable}.`;
      }

      function updateModuleCount() {
        if (!moduleCount) {
          return;
        }
        const count = Array.from(moduleInputs).filter((input) => input.checked).length;
        const label = count <= 1 ? 'sélectionnée' : 'sélectionnées';
        moduleCount.textContent = `(${count} ${label})`;
      }

      function syncCustomField(options = {}) {
        if (!customPill) {
          return;
        }
        const { focus = false } = options;
        if (customCheckbox.checked) {
          customPill.classList.add('is-active');
          customInput.required = true;
          if (focus) {
            customInput.focus();
          }
        } else {
          customPill.classList.remove('is-active');
          customInput.required = false;
          customInput.value = '';
          customInput.setCustomValidity('');
        }
      }

      function buildModuleSummary(modules, customText) {
        const labels = {
          connecter: 'Connecter vos systèmes et données pour une interopérabilité fluide.',
          liberer: 'Libérer du temps via l\'automatisation de vos processus clés.',
          normaliser: 'Normaliser votre patrimoine de données pour sécuriser la décision.',
          securiser: 'Sécuriser vos environnements et répondre aux exigences de conformité.',
          valoriser: 'Valoriser vos données grâce à des analyses actionnables.',
          collaborer: 'Faciliter la collaboration autour d\'espaces de partage unifiés.',
          anticiper: 'Anticiper les évolutions par l\'innovation et l\'expérimentation.'
        };

        const sentences = modules
          .map((value) => labels[value])
          .filter(Boolean);

        if (customText) {
          const safeText = escapeHtml(customText.trim());
          sentences.push(
            `Vous mettez aussi en avant : ${safeText}${ensureTrailingPunctuation(customText)}`
          );
        }

        if (!sentences.length) {
          return 'Nous vous proposons un diagnostic transversal pour identifier les priorités CLN.';
        }

        return sentences.join(' ');
      }

      function recommendationFromPriority(priority, customLabel) {
        const recommendations = {
          connecter: "Nous recommandons de prioriser un chantier d'interopérabilité pour fluidifier les échanges entre vos systèmes clés.",
          liberer: "Nous recommandons de lancer une séquence d'automatisation sur vos processus métiers critiques pour générer des gains rapides.",
          normaliser: "Nous recommandons de cadrer un programme de gouvernance des données afin de fiabiliser vos référentiels et décisions.",
          securiser: "Nous recommandons de bâtir une feuille de route conformité/sécurité pour renforcer vos environnements numériques.",
          valoriser: "Nous recommandons de mettre en place un socle analytics partagé pour valoriser vos données et éclairer les décisions.",
          collaborer: "Nous recommandons de structurer des espaces collaboratifs sécurisés pour fluidifier le partage entre équipes.",
          anticiper: "Nous recommandons de réserver un sprint d'innovation pour tester et préparer vos futurs cas d'usage."
        };

        if (recommendations[priority]) {
          return recommendations[priority];
        }

        if (priority === 'autre' && customLabel) {
          const safeLabel = escapeHtml(customLabel);
          return `Nous construirons avec vous un plan d'action spécifique autour de « ${safeLabel} ».`;
        }

        return "Explorons ensemble vos enjeux pour définir le plan d'action prioritaire.";
      }

      function rendezVousMessage(delai, mode) {
        const delais = {
          court: "Nous pouvons organiser un atelier d'immersion dans les 7 prochains jours pour cadrer les premières actions.",
          moyen: "Planifions un rendez-vous découverte afin de co-construire une feuille de route sur le semestre.",
          long: "Nous vous proposons un échange stratégique pour bâtir un programme progressif et maîtrisé.",
          incertain: "Clarifions ensemble le calendrier lors d'un échange exploratoire."
        };
        const modes = {
          flash: "Un diagnostic flash de 3 à 4 ateliers permettrait de prioriser vos chantiers.",
          projet: "Nous pouvons constituer une équipe projet CLN pour piloter vos livrables de bout en bout.",
          hybride: "Notre modèle hybride combine coaching de vos équipes et expertises ciblées CLN."
        };
        return `${delais[delai] || ""} ${modes[mode] || ""}`.trim();
      }

      function horizonSummary(delai) {
        const horizonLabels = {
          court: 'un horizon court terme (< 3 mois)',
          moyen: 'un horizon à moyen terme (3 à 6 mois)',
          long: 'un horizon à plus de 6 mois',
          incertain: 'un horizon encore à préciser'
        };
        return horizonLabels[delai] || 'un horizon à définir';
      }

      if (priorityList) {
        priorityList.addEventListener('click', (event) => {
          const button = event.target.closest('.priority-move');
          if (!button) {
            return;
          }
          const item = button.closest('.priority-item');
          if (!item) {
            return;
          }
          if (!isPriorityEnabled()) {
            return;
          }
          if (button.classList.contains('priority-up')) {
            const previous = item.previousElementSibling;
            if (previous) {
              priorityList.insertBefore(item, previous);
            }
          }
          if (button.classList.contains('priority-down')) {
            const next = item.nextElementSibling;
            if (next) {
              priorityList.insertBefore(next, item);
            }
          }
          refreshPriorityUI();
        });
      }
      if (priorityToggle) {
        priorityToggle.addEventListener('change', () => {
          refreshPriorityUI();
        });
      }

      moduleInputs.forEach((input) => {
        input.addEventListener('change', () => {
          if (input === customCheckbox) {
            syncCustomField({ focus: input.checked });
          }
          updateModuleCount();
          buildPriorityList(getSelectedModuleEntries());
        });
      });

      if (customInput) {
        customInput.addEventListener('input', () => {
          customInput.setCustomValidity('');
          buildPriorityList(getSelectedModuleEntries());
        });
      }

      syncCustomField();
      updateModuleCount();
      buildPriorityList(getSelectedModuleEntries());

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        if (customCheckbox.checked && !customInput.value.trim()) {
          customInput.setCustomValidity('Veuillez décrire votre enjeu.');
          customInput.reportValidity();
          return;
        }
        customInput.setCustomValidity('');

        const selectedCheckboxes = Array.from(
          form.querySelectorAll('input[name="modules"]:checked')
        );
        const modules = selectedCheckboxes
          .map((input) => input.value)
          .filter((value) => value !== 'autre');
        const customModule = customCheckbox.checked ? customInput.value.trim() : '';
        const taille = form.elements['taille'].value;
        const priorityEnabled = isPriorityEnabled();
        const priorityOrder = priorityEnabled ? getPriorityOrder() : [];
        const prioriteEntry = priorityEnabled ? priorityOrder[0] || null : null;
        const priorite = prioriteEntry ? prioriteEntry.value : '';
        if (priorityInput) {
          priorityInput.value = priorityEnabled && prioriteEntry ? prioriteEntry.key : '';
        }
        const delai = form.elements['delai'].value;
        const mode = form.elements['mode'].value;

        const tailleLabel = {
          petite: "une organisation agile en croissance",
          moyenne: "une structure en phase de structuration",
          grande: "un groupe établi avec plusieurs équipes métiers",
          tresgrande: "un grand groupe international avec plusieurs entités"
        }[taille];

        const moduleSummary = buildModuleSummary(modules, customModule);
        const priorityRecommendation = recommendationFromPriority(priorite, prioriteEntry ? prioriteEntry.label : '');
        const prioritySummary = buildPriorityOrderSummary(priorityOrder, priorityEnabled);
        const meetingMessage = rendezVousMessage(delai, mode);
        const horizonText = horizonSummary(delai);
        const topPriorityLabel = prioriteEntry ? prioriteEntry.label : '';
        const topPriorityLabelSafe = topPriorityLabel ? escapeHtml(topPriorityLabel) : '';
        const topPriorityHighlight = priorityEnabled && topPriorityLabel
          ? `Priorité #1 : ${topPriorityLabelSafe}.`
          : "Priorité #1 : à déterminer (classement optionnel non activé).";
        const organisationLine = `Vous êtes ${tailleLabel || "une organisation"} avec ${horizonText}.`;
        const recommendationLine = `${topPriorityHighlight} ${priorityRecommendation}`;
        const nextStepLine = meetingMessage || "Planifions un échange pour préciser les prochaines étapes.";

        insightsContainer.innerHTML = `
          <p><strong>Profil.</strong> ${organisationLine}</p>
          <p><strong>Enjeux principaux.</strong> ${moduleSummary}</p>
          <p><strong>Feuille de route 6 mois.</strong> ${prioritySummary} ${recommendationLine}</p>
          <p><strong>Prochain pas.</strong> ${nextStepLine}</p>
          <p>Transmettez-nous vos coordonnées et vos disponibilités via la page contact : nous reviendrons vers vous sous 48&nbsp;heures.</p>
        `;

        try {
          const payload = {
            html: insightsContainer.innerHTML,
            generatedAt: new Date().toISOString(),
            meta: {
              organisationLine,
              moduleSummary,
              prioritySummary,
              recommendationLine,
              nextStepLine
            }
          };
          localStorage.setItem('clnRecommendation', JSON.stringify(payload));
        } catch (error) {
          console.warn('Impossible de stocker la recommandation localement.', error);
        }

        card.hidden = false;
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    </script>
  </body>
</html>
