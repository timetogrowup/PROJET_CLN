name: Deploy to Hostinger

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload site to Hostinger
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          server-dir: ${{ secrets.HOSTINGER_FTP_DIR != '' && secrets.HOSTINGER_FTP_DIR || '/public_html/' }}
          protocol: ftps
          state-name: hostinger-deploy-state.json
          exclude: |
            **/.git*
            **/.github/workflows/**
            **/.env
            **/*.ps1
            **/*.py
            PRESENTATION_PPT/**

      - name: Wait for propagation
        run: sleep 10

      - name: Smoke test contact form
        id: contact_test
        env:
          CONTACT_URL: ${{ secrets.HOSTINGER_CONTACT_URL }}
          CONTACT_TEST_EMAIL: ${{ secrets.HOSTINGER_CONTACT_TEST_EMAIL }}
        run: |
          set -euo pipefail
          url="${CONTACT_URL:-https://cln-solutions.fr/contact.php}"
          email="${CONTACT_TEST_EMAIL:-patrick.lyonnet@cln-solutions.fr}"
          timestamp="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          status=$(curl -sS -D /tmp/contact_headers.txt -o /tmp/contact_body.txt -w "%{http_code}" \
            -X POST "$url" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "name=CLN Automation Check" \
            --data-urlencode "_replyto=${email}" \
            --data-urlencode "company=Automation workflow" \
            --data-urlencode "message=Smoke test triggered by GitHub Actions on ${timestamp}." \
            --data-urlencode "consent=on")

          echo "http_status=$status" >> "$GITHUB_OUTPUT"

          if [ "$status" != "303" ]; then
            echo "Unexpected HTTP status: $status"
            cat /tmp/contact_body.txt
            exit 1
          fi

          location=$(grep -i "^Location:" /tmp/contact_headers.txt | tr -d '\r' | awk '{print $2}')
          echo "redirect_location=${location:-unknown}" >> "$GITHUB_OUTPUT"

          if ! grep -qi "status=success" <<< "${location:-}"; then
            echo "Form submission did not redirect to success page."
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "HTTP status: ${{ steps.contact_test.outputs.http_status }}"
          echo "Redirect location: ${{ steps.contact_test.outputs.redirect_location }}"
